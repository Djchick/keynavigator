/*!
 * Key navigator plugin for jQuery / Zepto.
 *
 * https://github.com/nekman/keynavigator
 */

(function(e,t){typeof exports=="object"?module.exports=t(require("jquery")):typeof e.define=="function"&&e.define.amd?define("keynavigator",["jquery"],t):t(e.jQuery||e.Zepto)})(this,function(e){var t=function(t,n){var r=n||{};this.options=e.extend({},this.defaults,r),this.options.keys=e.extend({},this.defaults.keys,r.keys),this.$nodes=t,this.$parent=this.options.parent?e(this.options.parent):t.parent(),this.options.removeOutline&&this.$parent.css({outline:"none"}),this.$parent.attr("tabindex")||this.$parent.attr({tabindex:this.options.tabindex||-1})};t.keys={0:"?",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause_break",20:"caps_lock",27:"escape",33:"page_up",34:"page_down",35:"end",36:"home",37:"left_arrow",38:"up_arrow",39:"right_arrow",40:"down_arrow",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"left_window_key",92:"right_window_key",93:"select_key",96:"numpad_0",97:"numpad_1",98:"numpad_2",99:"numpad_3",100:"numpad 4",101:"numpad_5",102:"numpad_6",103:"numpad_7",104:"numpad_8",105:"numpad_9",106:"multiply",107:"add",109:"subtract",110:"decimal point",111:"divide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"num_lock",145:"scroll_lock",186:";",187:"=",188:",",189:"dash",190:".",191:"/",192:"grave_accent",219:"open_bracket",220:"\\",221:"close_braket",222:"single_quote"},t.prototype={defaults:{useCache:!0,cycle:!0,activateOn:"click",parentFocusOn:"click",activeClass:"active",removeOutline:!0,keys:{up_arrow:"up",down_arrow:"down",left_arrow:"left",right_arrow:"right"}},move:function(e){var t=e.cells[e.cellPosition],n=t[e.index];!n&&this.options.cycle&&(n=t[e.firstIndex?0:t.length-1]);if(!n)return;this.setActive(n.$el)},down:function(e,t){e.trigger("down",[e]);var r=this.cellTable.columns;this.move({cellPosition:n.createFrom(e).pos.left,index:t.rowIndex+1,cells:r,firstIndex:!0})},up:function(e,t){e.trigger("up",[e]);var r=this.cellTable.columns;this.move({cellPosition:n.createFrom(e).pos.left,index:t.rowIndex-1,cells:r})},left:function(e,t){e.trigger("left",[e]);var r=this.cellTable.rows;this.move({cellPosition:n.createFrom(e).pos.top,index:t.colIndex-1,cells:r})},right:function(e,t){e.trigger("right",[e]);var r=this.cellTable.rows;this.move({cellPosition:n.createFrom(e).pos.top,index:t.colIndex+1,cells:r,firstIndex:!0})},findCell:function(e){try{return this.cellTable.getCurrent(e)}catch(t){}return this.reBuild(),this.cellTable.getCurrent(e)},handleKeyDown:function(e){var n=this.options.keys[t.keys[e.which]]||this.options.keys[e.which];if(!n)return;e.preventDefault?e.preventDefault():e.returnValue=!1,(!this.cellTable||!this.options.useCache)&&this.reBuild();var r=this.$parent.find("."+this.options.activeClass);r.length||(r=this.$nodes.first());if(!r.length)return;var i=this.findCell(r),s=this[n];if(s)return s.apply(this,[r,i,e]);n.apply(this,[r,i,e])},setActive:function(e){this.$nodes.removeClass(this.options.activeClass),e.addClass(this.options.activeClass)},reBuild:function(){var t=this.$parent,n=this;this.options.useCache||(this.$nodes=e(this.$nodes.selector)),t.off("keydown").off(this.options.parentFocusOn).on("keydown",e.proxy(this.handleKeyDown,this)).on(this.options.parentFocusOn,function(){t.focus()}),this.$nodes.off(this.options.activateOn).on(this.options.activateOn,function(){n.setActive(e(this))}),this.cellTable=new r(this.$nodes)}},e.fn.keynavigator=function(n){var r=new t(this,n),i;return e(window).on("resize",function(){clearTimeout(i),i=setTimeout(function(){r.reBuild()},200)}),r.reBuild(),e.extend(this,{keynavigator:r})};var n={createFrom:function(e){var t=e.position();return{pos:{left:Math.round(t.left),top:Math.round(t.top)},$el:e}}},r=function(e){this.table=this.buildTable(e),this.rows=this.buildRows(),this.columns=this.buildColumns()};return r.prototype={buildTable:function(t){return t.map(function(){return n.createFrom(e(this))})},buildColumns:function(){var t={},n=this;return e.each(this.table,function(e,r){t[r.pos.left]=n.getColumnElements(r)}),t},buildRows:function(){var t={},n=this;return e.each(this.table,function(e,r){t[r.pos.top]=n.getRowElements(r)}),t},getRowElements:function(t){var n=this;return e.map(this.table,function(e){return n.isSameRow(e,t)?e:null})},getColumnElements:function(t){var n=this;return e.map(this.table,function(e){return n.isSameColumn(e,t)?e:null})},getCurrent:function(e){var t=n.createFrom(e);return this.findPosition(this.getCell(t))},isSameColumn:function(e,t){if(!t)throw"cell";return e.pos.left===t.pos.left},isSameRow:function(e,t){return e.pos.top===t.pos.top},isSame:function(e,t){return this.isSameColumn(e,t)&&this.isSameRow(e,t)},getCell:function(t){var n=this;return e.map(this.table,function(e){return n.isSame(t,e)?e:null})[0]},findIndex:function(e,t){var n=0,r=e.length;for(n=0;n<r;n++)if(t(e[n]))return n;return n},findPosition:function(e){var t=this.getColumnElements(e),n=this.getRowElements(e),r=this.findIndex(t,function(t){return t.pos.top==e.pos.top}),i=this.findIndex(n,function(t){return t.pos.left==e.pos.left});return{colIndex:i,rowIndex:r}}},e});