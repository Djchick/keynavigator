/*!
 * Key navigator plugin for jQuery / Zepto.
 *
 * https://github.com/nekman/keynavigator
 */

!function(t,e){"object"==typeof exports?module.exports=e(require("jquery")):"function"==typeof t.define&&t.define.amd?define("keynavigator",["jquery"],e):e(t.jQuery||t.Zepto)}(this,function(t){var e={createFrom:function(t){var e=t.position();return{pos:{left:Math.round(e.left),top:Math.round(e.top)},$el:t}}},n=function(t){this.table=this.buildTable(t),this.rows=this.buildRows(),this.columns=this.buildColumns()};n.prototype={buildTable:function(n){return n.map(function(){return e.createFrom(t(this))})},buildColumns:function(){var e={},n=this;return t.each(this.table,function(t,i){e[i.pos.left]=n.getColumnElements(i)}),e},buildRows:function(){var e={},n=this;return t.each(this.table,function(t,i){e[i.pos.top]=n.getRowElements(i)}),e},getRowElements:function(e){var n=this;return t.map(this.table,function(t){return n.isSameRow(t,e)?t:null})},getColumnElements:function(e){var n=this;return t.map(this.table,function(t){return n.isSameColumn(t,e)?t:null})},getCurrent:function(t){var n=e.createFrom(t);return this.findPosition(this.getCell(n))},isSameColumn:function(t,e){if(!e)throw"cell";return t.pos.left===e.pos.left},isSameRow:function(t,e){return t.pos.top===e.pos.top},isSame:function(t,e){return this.isSameColumn(t,e)&&this.isSameRow(t,e)},getCell:function(e){var n=this;return t.map(this.table,function(t){return n.isSame(e,t)?t:null})[0]},findIndex:function(t,e){var n=0,i=t.length;for(n=0;i>n;n++)if(e(t[n]))return n;return n},findPosition:function(t){var e=this.getColumnElements(t),n=this.getRowElements(t),i=this.findIndex(e,function(e){return e.pos.top==t.pos.top}),o=this.findIndex(n,function(e){return e.pos.left==t.pos.left});return{colIndex:o,rowIndex:i}}};var i={0:"?",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause_break",20:"caps_lock",27:"escape",33:"page_up",34:"page_down",35:"end",36:"home",37:"left_arrow",38:"up_arrow",39:"right_arrow",40:"down_arrow",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"left_window_key",92:"right_window_key",93:"select_key",96:"numpad_0",97:"numpad_1",98:"numpad_2",99:"numpad_3",100:"numpad 4",101:"numpad_5",102:"numpad_6",103:"numpad_7",104:"numpad_8",105:"numpad_9",106:"multiply",107:"add",109:"subtract",110:"decimal point",111:"divide",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"num_lock",145:"scroll_lock",186:";",187:"=",188:",",189:"dash",190:".",191:"/",192:"grave_accent",219:"open_bracket",220:"\\",221:"close_braket",222:"single_quote"},o=function(e,n){var i=n||{};this.options=t.extend({},this.defaults,i),this.options.keys=t.extend({},this.defaults.keys,i.keys),this.$nodes=e,this.$parent=this.options.parent?t(this.options.parent):e.parent(),this.options.removeOutline&&this.$parent.css({outline:"none"}),this.$parent.attr("tabindex")||this.$parent.attr({tabindex:this.options.tabindex||-1})};return o.keys=i,o.prototype={defaults:{useCache:!0,cycle:!0,activateOn:"click",parentFocusOn:"click",activeClass:"active",removeOutline:!0,keys:{up_arrow:"up",down_arrow:"down",left_arrow:"left",right_arrow:"right"},onBeforeActive:t.noop,onAfterActive:t.noop},move:function(t){var e=t.cells[t.cellPosition],n=e[t.index];!n&&this.options.cycle&&(n=e[t.firstIndex?0:e.length-1]),n&&this.setActive(n.$el)},down:function(t,n){t.trigger("down",[t]);var i=this.cellTable.columns;this.move({cellPosition:e.createFrom(t).pos.left,index:n.rowIndex+1,cells:i,firstIndex:!0})},up:function(t,n){t.trigger("up",[t]);var i=this.cellTable.columns;this.move({cellPosition:e.createFrom(t).pos.left,index:n.rowIndex-1,cells:i})},left:function(t,n){t.trigger("left",[t]);var i=this.cellTable.rows;this.move({cellPosition:e.createFrom(t).pos.top,index:n.colIndex-1,cells:i})},right:function(t,n){t.trigger("right",[t]);var i=this.cellTable.rows;this.move({cellPosition:e.createFrom(t).pos.top,index:n.colIndex+1,cells:i,firstIndex:!0})},findCell:function(t){try{return this.cellTable.getCurrent(t)}catch(e){}return this.reBuild(),this.cellTable.getCurrent(t)},handleKeyDown:function(t){var e=this.options.keys[o.keys[t.which]]||this.options.keys[t.which];if(e){t.preventDefault?t.preventDefault():t.returnValue=!1,this.cellTable&&this.options.useCache||this.reBuild();var n=this.$parent.find("."+this.options.activeClass);if(n.length||(n=this.$nodes.first()),n.length){var i=this.findCell(n),s=this[e];return s?s.apply(this,[n,i,t]):(e.apply(this,[n,i,t]),void 0)}}},onBeforeActive:function(t){return this.options.onBeforeActive.apply(this,[t])},onAfterActive:function(t){return this.options.onAfterActive.apply(this,[t])},setActive:function(t){var e=this.onBeforeActive(t);e!==!1&&(this.$nodes.removeClass(this.options.activeClass),t.addClass(this.options.activeClass)),this.onAfterActive(t)},reBuild:function(){var e=this.$parent,i=this;this.options.useCache||(this.$nodes=t(this.$nodes.selector)),e.off("keydown").off(this.options.parentFocusOn).on("keydown",t.proxy(this.handleKeyDown,this)).on(this.options.parentFocusOn,function(){e.focus()});var o=this.$nodes.filter(function(){return!t(this).attr("keynavigator-watched")});o.attr("keynavigator-watched",!0).on(this.options.activateOn,function(){i.setActive(t(this))}),this.cellTable=new n(this.$nodes)}},t.fn.keynavigator=function(e){var n,i=new o(this,e);return t(window).on("resize",function(){clearTimeout(n),n=setTimeout(function(){i.reBuild()},200)}),i.reBuild(),t.extend(this,{keynavigator:i})},t});